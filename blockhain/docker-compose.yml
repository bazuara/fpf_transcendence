version: '3.8'

services:
  ganache:
    build:
      context: .
      dockerfile: Dockerfile.ganache
    command: ganache-cli -h 0.0.0.0 -p 8545 -i 5777
    ports:
      - "8545:8545"
    networks:
      - mynetwork
    volumes:
      - ganache_data:/ganache_data
    healthcheck:
      test: ["CMD", "curl", "-s", "http://localhost:8545"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
      start_interval: 5s
    restart: always

  truffle:
    build:
      context: .
      dockerfile: Dockerfile.truffle
    command: truffle migrate --network development
    volumes:
      - ./contracts:/app/contracts
      - ./bc_migrations:/app/migrations
      - ./build:/app/build
      - ./truffle-config.js:/app/truffle-config.js
      - ./output:/app/output
    depends_on:
      - ganache
    networks:
      - mynetwork
    working_dir: /app
    restart: on-failure
    environment:
      - HOST=ganache
      - PORT=8545
      - NETWORK_ID=5777

  python:
    image: python:3.12.5
    volumes:
      - ./scripts:/app/scripts
      - ./output:/app/output
      - ./build:/app/build
    depends_on:
      - ganache
      - truffle
    networks:
      - mynetwork
    working_dir: /app
    command: tail -f /dev/null # Keep the container running, debugging purposes only
    restart: on-failure

volumes:
  ganache_data:

networks:
  mynetwork:
    driver: bridge
